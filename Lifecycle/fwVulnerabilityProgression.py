#!/usr/bin/env python
import json
import requests
# import csv

# ========= ENVIRONMENT VARIABLES ========
url = "http://localhost:8070/" #URL including trailing '/'
username = "admin"
password = "admin!23"
repoID = "464bedf382604dc29a858ec8e703a493"
outputFile="timeline.csv"
# =============================================


#Default variables



def get_repository_audit_report():
    # https://help.sonatype.com/en/repository-results-view-rest-api.html
    print("Getting Current Reports...")
    global url
    payload = json.dumps({
        "page": 1,
        "pageSize": 1000,
        "matchStateFilters": [
            "MATCH_STATE_EXACT"
        ],
        "violationStateFilters": [
            "VIOLATION_STATE_OPEN"
            # "VIOLATION_STATE_ALL"
        ],
        "searchFilters": [
            {
            "filterableField": "REPOSIOTRY_MANAGER_ID",
            "value": repoID
            }
        ],
        "threatLevelFilters":[7, 9],
        "aggregate" : [ False ],
        "sortFields": [
            {
            "sortableField": "POLICY_NAME",
            "asc": False,
            "sortPriority": 1
            }
        ]
    })
    
    res = requests.post(url+"api/experimental/repositories/repository_manager/"+repoID+"/results/details", auth=(username, password), data=payload) #, timeout=120
    print(res.text)
    res = json.loads(res.text)
    # print(res)

    f = open("tmp.json", "w")
    f.write(json.dumps(res))
    f.close()
    print("DONE!")

    

#==========================
#========== MAIN ==========
#==========================
if __name__ == "__main__":
    get_repository_audit_report()
    

    #Write to CSV file
    # with open("compare-iq-reports.csv","w+") as my_csv:
    #     csvWriter = csv.writer(my_csv,delimiter=',')
    #     csvWriter.writerow(headerRow)
    #     csvWriter.writerows(csvData)

    # print("Results written to compare-iq-reports.csv")